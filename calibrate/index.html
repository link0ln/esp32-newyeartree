<!DOCTYPE html>
<html><head><title>LED Calibrate</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Arial;background:#1a1a2e;color:#fff;min-height:100vh}
.h{text-align:center;padding:10px;background:rgba(0,0,0,.3)}
.h a{color:#0f8;text-decoration:none;margin:0 10px}
.c{max-width:100%;margin:0 auto;padding:10px}
.v{position:relative;width:100%;max-width:640px;margin:0 auto;background:#000;border-radius:8px;overflow:hidden}
video,canvas{width:100%;display:block}
#overlay{position:absolute;top:0;left:0;pointer-events:none}
.s{background:rgba(0,0,0,.5);padding:15px;border-radius:8px;margin:10px 0}
.s h3{color:#0f8;margin-bottom:10px}
.i{display:flex;gap:10px;margin:10px 0;flex-wrap:wrap;justify-content:center}
.b{padding:12px 20px;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:bold}
.bp{background:#764ba2;color:#fff}
.bg{background:#00b894;color:#fff}
.br{background:#d63031;color:#fff}
.by{background:#fdcb6e;color:#000}
.bb{background:#0984e3;color:#fff}
.st{font-size:1.2em;text-align:center;padding:10px}
.st span{color:#0f8}
.prog{width:100%;height:20px;background:rgba(255,255,255,.1);border-radius:10px;overflow:hidden;margin:10px 0}
.prog div{height:100%;background:linear-gradient(90deg,#00b894,#0f8);transition:width .3s}
.det{text-align:center;padding:10px;color:#fdcb6e}
.coord{display:flex;gap:20px;justify-content:center;margin:10px 0}
.coord div{background:rgba(255,255,255,.1);padding:10px 20px;border-radius:6px}
.coord span{color:#0f8;font-weight:bold}
select{padding:8px;border-radius:4px;background:#2d3436;color:#fff;border:1px solid #0f8}
.tip{font-size:12px;color:#888;margin-top:5px}
.mem{font-size:11px;color:#0f8;text-align:center}
</style>
</head><body>
<div class="h"><a href="/">Home</a>|<a href="/led">LED</a>|<a href="/calibrate">Calibrate</a></div>
<div class="c">
<div class="s">
<h3>3D LED Mapping</h3>
<div class="i">
<select id="plane"><option value="xy">XY (Front)</option><option value="zy">ZY (Side)</option></select>
<select id="color" onchange="setColor()">
<option value="w">White</option>
<option value="r">Red</option>
<option value="g" selected>Green</option>
<option value="b">Blue</option>
</select>
<button class="b bg" id="startBtn" onclick="startAuto()">Start</button>
<button class="b br" id="stopBtn" onclick="stopAuto()" style="display:none">Stop</button>
</div>
<div class="tip">Select color for better detection in bright rooms</div>
<div class="mem" id="mem">Stored: 0</div>
</div>

<div class="v">
<video id="vid" autoplay playsinline></video>
<canvas id="overlay"></canvas>
</div>

<div class="s">
<div class="st">Pixel: <span id="pix">-</span> / <span id="total">{{NUM}}</span></div>
<div class="prog"><div id="prog" style="width:0%"></div></div>
<div class="coord"><div>X: <span id="cx">-</span></div><div>Y: <span id="cy">-</span></div></div>
<div class="det" id="det">Point camera at LEDs</div>
</div>

<div class="s">
<div class="i">
<button class="b bb" onclick="prev()">&lt;</button>
<button class="b by" onclick="blink()">Blink</button>
<button class="b bp" onclick="skip()">Skip</button>
<button class="b bg" onclick="saveNext()">Save &gt;</button>
</div>
</div>

<div class="s">
<h3>Data</h3>
<div class="i">
<button class="b bg" onclick="uploadToDevice()">Upload</button>
<button class="b bb" onclick="downloadJSON()">Download</button>
<button class="b br" onclick="clearData()">Clear</button>
</div>
</div>
</div>

<script>
const T={{NUM}};
let v,c,x,o,ox,det=0,dX=0,dY=0,th=150,auto=0,dc=0,nc=0,px=0;
let detCh=1; // 0=R, 1=G, 2=B, 3=brightness
let busy=0; // prevent race conditions
const K='led_cal';

function g(){try{return JSON.parse(localStorage.getItem(K)||'{}')}catch(e){return{}}}
function sC(p,x,y,pl){let d=g();if(!d[p])d[p]={x:0,y:0,z:0};if(pl=='xy'){d[p].x=x;d[p].y=y}else{d[p].z=x}localStorage.setItem(K,JSON.stringify(d));uM()}
function skC(p){let d=g();if(!d[p])d[p]={x:-1,y:-1,z:-1};localStorage.setItem(K,JSON.stringify(d));uM()}
function uM(){document.getElementById('mem').textContent='Stored: '+Object.keys(g()).length}

function setColor(){
    const col=document.getElementById('color').value;
    // Set detection channel: r=0, g=1, b=2, w=brightness
    if(col=='r')detCh=0;else if(col=='g')detCh=1;else if(col=='b')detCh=2;else detCh=3;
    fetch('/calibrate/color?c='+col);
}

async function iC(){
v=document.getElementById('vid');c=document.createElement('canvas');x=c.getContext('2d');
o=document.getElementById('overlay');ox=o.getContext('2d');
if(!navigator.mediaDevices)navigator.mediaDevices={};
if(!navigator.mediaDevices.getUserMedia){
navigator.mediaDevices.getUserMedia=function(c){
var gUM=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;
if(!gUM)return Promise.reject(new Error('Camera not supported over HTTP. Use chrome://flags/#unsafely-treat-insecure-origin-as-secure'));
return new Promise((y,n)=>gUM.call(navigator,c,y,n));}}
try{
const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:640},height:{ideal:480}}});
v.srcObject=s;v.onloadedmetadata=()=>{c.width=v.videoWidth;c.height=v.videoHeight;o.width=v.videoWidth;o.height=v.videoHeight;det=1;dL()};
}catch(e){document.getElementById('det').innerHTML='Camera error: '+e.message;document.getElementById('det').style.color='#f66'}}

function dL(){
if(!det)return;x.drawImage(v,0,0);let f=x.getImageData(0,0,c.width,c.height),d=f.data,sX=0,sY=0,cnt=0;
for(let y=0;y<c.height;y++)for(let i=0;i<c.width;i++){
    let j=(y*c.width+i)*4;
    let r=d[j],g=d[j+1],b=d[j+2],val=0;
    if(detCh==3){val=(r+g+b)/3;if(val<th)val=0}  // brightness mode
    else if(detCh==0){val=r-Math.max(g,b);if(val<30)val=0}  // red minus others
    else if(detCh==1){val=g-Math.max(r,b);if(val<30)val=0}  // green minus others
    else if(detCh==2){val=b-Math.max(r,g);if(val<30)val=0}  // blue minus others
    if(val>0){sX+=i*val;sY+=y*val;cnt+=val}
}
ox.clearRect(0,0,o.width,o.height);
if(cnt>0){dX=sX/cnt;dY=sY/cnt;let nx=dX/c.width,ny=dY/c.height;
document.getElementById('cx').textContent=nx.toFixed(3);document.getElementById('cy').textContent=ny.toFixed(3);
document.getElementById('det').textContent='Detected!';document.getElementById('det').style.color='#0b8';
const clr=detCh==0?'#f00':detCh==1?'#0f0':detCh==2?'#00f':'#0f8';
ox.strokeStyle=clr;ox.lineWidth=2;ox.beginPath();ox.arc(dX,dY,20,0,Math.PI*2);ox.stroke();
dc++;nc=0;if(auto&&dc>=5){dc=0;aSN()}}
else{document.getElementById('det').textContent='Searching...';document.getElementById('det').style.color='#fc6';dc=0;nc++;if(auto&&nc>=30){nc=0;aSkN()}}
requestAnimationFrame(dL)}

function aSN(){if(!auto||busy||px>=T-1)return;busy=1;let pl=document.getElementById('plane').value,nx=dX/c.width,ny=dY/c.height;sC(px,nx,ny,pl);
fetch('/calibrate/next').then(r=>r.json()).then(d=>{busy=0;px=d.pixel;uS(d);if(d.status=='complete')stA()}).catch(()=>busy=0)}
function aSkN(){if(!auto||busy||px>=T-1)return;busy=1;skC(px);fetch('/calibrate/next').then(r=>r.json()).then(d=>{busy=0;px=d.pixel;uS(d);if(d.status=='complete')stA()}).catch(()=>busy=0)}

function startAuto(){
const col=document.getElementById('color').value;busy=0;
fetch('/calibrate/start?c='+col).then(r=>r.json()).then(d=>{px=d.pixel;uS(d);auto=1;dc=0;nc=0;
document.getElementById('startBtn').style.display='none';document.getElementById('stopBtn').style.display='inline-block';
document.getElementById('det').textContent='Auto scanning...'})}
function stA(){auto=0;busy=0;document.getElementById('startBtn').style.display='inline-block';document.getElementById('stopBtn').style.display='none';fetch('/calibrate/stop')}
function stopAuto(){stA()}

function prev(){fetch('/calibrate/prev').then(r=>r.json()).then(d=>{px=d.pixel;uS(d)})}
function skip(){skC(px);fetch('/calibrate/next').then(r=>r.json()).then(d=>{px=d.pixel;uS(d)})}
function blink(){fetch('/calibrate/blink')}
function saveNext(){let pl=document.getElementById('plane').value,nx=dX/c.width,ny=dY/c.height;sC(px,nx,ny,pl);
fetch('/calibrate/next').then(r=>r.json()).then(d=>{px=d.pixel;uS(d)})}

function uS(d){if(d.pixel!==undefined){document.getElementById('pix').textContent=d.pixel;document.getElementById('prog').style.width=((d.pixel/T)*100)+'%'}
if(d.status=='complete'){document.getElementById('det').textContent='Complete!'}}

function uploadToDevice(){let d=JSON.stringify(g());
fetch('/calibrate/upload',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:'data='+encodeURIComponent(d)})
.then(r=>r.json()).then(d=>{if(d.status=='saved')alert('Uploaded '+d.size+' bytes!');else alert('Error: '+(d.error||'?'))}).catch(e=>alert('Failed: '+e))}
function downloadJSON(){let d=g(),b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download='led_coords.json';a.click();URL.revokeObjectURL(u)}
function clearData(){if(confirm('Clear all?')){localStorage.removeItem(K);uM()}}

iC();uM();setColor();fetch('/calibrate/status').then(r=>r.json()).then(d=>{px=d.pixel;if(d.active)uS(d)});
</script>
</body></html>
